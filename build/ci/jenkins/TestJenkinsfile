#!/usr/bin/env groovy

pipeline {
    agent none
    options {
        timestamps()
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder logRotator(artifactDaysToKeepStr: '30')
        // parallelsAlwaysFailFast()
    }
    stages {
        stage ('E2E Test') {
            matrix {
                axes {
                    axis {
                        name 'MILVUS_SERVER_TYPE'
                        values 'standalone', 'distributed'
                    }
                }
                agent {
                    kubernetes {
                        label "milvus-e2e-test-kind"
                        defaultContainer 'main'
                        yamlFile "build/ci/jenkins/pod/krte.yaml"
                        customWorkspace '/home/jenkins/agent/workspace'
                        // We allow this pod to remain active for a while, later jobs can
                        // reuse cache in previous created nodes.
                        idleMinutes 120
                    }
                }
                environment {
                    PROJECT_NAME = "milvus"
                    SEMVER = "${BRANCH_NAME.contains('/') ? BRANCH_NAME.substring(BRANCH_NAME.lastIndexOf('/') + 1) : BRANCH_NAME}"
                    IMAGE_REPO = "dockerhub-mirror-sh.zilliz.cc/milvusdb"
                    DOCKER_BUILDKIT = 1
                    ARTIFACTS = "${env.WORKSPACE}/artifacts"
                }
                stages {
                    stage("Env Variables") {
                        steps {
                            sh "printenv"
                        }
                    }
                }
            }
        }
    }
}
